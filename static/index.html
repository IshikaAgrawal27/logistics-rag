<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LogiRAG — Logistics Intelligence</title>
  <meta name="description" content="Ask questions about your logistics documents using AI-powered retrieval." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* ── Reset & Base ─────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #0d0e14;
      --sidebar:     #0f1018;
      --surface:     #13141c;
      --surface2:    #191a24;
      --surface3:    #1f2030;
      --border:      #27293a;
      --border2:     #333549;
      --text:        #dde0f0;
      --subtext:     #7e82a0;
      --muted:       #4a4d68;
      --accent:      #4f72ff;
      --accent2:     #3556e0;
      --accent-glow: rgba(79,114,255,0.18);
      --accent-soft: rgba(79,114,255,0.08);
      --user-bubble: #1a1f42;
      --success:     #10b981;
      --danger:      #ef4444;
      --warning:     #f59e0b;
      --success-bg:  #052e1c;
      --danger-bg:   #2d0b0b;
      --warning-bg:  #2d1c05;
      --scrollbar:   #27293a;
      --radius:      8px;
      --radius-lg:   12px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 15px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 99px; }

    /* ── Layout shell ──────────────────────────────────────────── */
    .shell {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Sidebar ──────────────────────────────────────────────── */
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 1.25rem 1.25rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar-logo {
      width: 30px;
      height: 30px;
      background: var(--accent);
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .sidebar-logo svg {
      width: 16px; height: 16px;
      stroke: #fff; fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }
    .sidebar-brand-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .sidebar-brand-sub {
      font-size: 0.65rem;
      color: var(--muted);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.1rem 1.1rem 0;
    }

    .sidebar-footer {
      padding: 1rem 1.1rem;
      border-top: 1px solid var(--border);
    }

    .section-label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.5rem;
      display: block;
    }

    /* Status pills */
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      font-size: 0.76rem;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 20px;
      margin-bottom: 4px;
    }
    .status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-online  { background: var(--success-bg); color: var(--success); border: 1px solid rgba(16,185,129,0.2); }
    .status-offline { background: var(--danger-bg);  color: var(--danger);  border: 1px solid rgba(239,68,68,0.2); }
    .status-warn    { background: var(--warning-bg); color: var(--warning); border: 1px solid rgba(245,158,11,0.2); }
    .dot-online  { background: var(--success); }
    .dot-offline { background: var(--danger); }
    .dot-warn    { background: var(--warning); }

    .status-group { margin-bottom: 1rem; }
    .status-group .status-pill { display: flex; }

    .offline-notice {
      background: var(--danger-bg);
      border: 1px solid rgba(239,68,68,0.18);
      border-radius: var(--radius);
      padding: 9px 12px;
      font-size: 0.78rem;
      color: var(--subtext);
      line-height: 1.6;
      margin-top: 4px;
    }
    .offline-notice code {
      color: var(--accent);
      font-size: 0.76rem;
      font-family: 'Courier New', monospace;
    }

    .sidebar-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.9rem 0;
    }

    /* Document list */
    #doc-list { list-style: none; }
    .doc-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 9px;
      border-radius: 7px;
      margin-bottom: 2px;
      transition: background 0.12s;
    }
    .doc-item:hover { background: var(--surface2); }
    .doc-badge {
      width: 28px; height: 28px;
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.62rem; font-weight: 700;
      color: var(--subtext);
      letter-spacing: 0.04em;
      flex-shrink: 0;
    }
    .doc-name {
      flex: 1;
      font-size: 0.79rem;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .doc-size {
      font-size: 0.69rem;
      color: var(--muted);
      flex-shrink: 0;
    }
    .doc-remove {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 0.75rem;
      padding: 2px 5px;
      border-radius: 4px;
      line-height: 1;
      transition: color 0.12s, background 0.12s;
      flex-shrink: 0;
    }
    .doc-remove:hover { color: var(--danger); background: var(--danger-bg); }

    .no-docs-note {
      font-size: 0.8rem;
      color: var(--muted);
      font-style: italic;
      padding: 2px 0;
    }

    /* Sidebar action button */
    .sidebar-btn {
      display: flex;
      align-items: center;
      gap: 7px;
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: transparent;
      color: var(--subtext);
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.12s, color 0.12s, border-color 0.12s;
    }
    .sidebar-btn:hover {
      background: var(--surface2);
      color: var(--text);
      border-color: var(--border2);
    }

    /* Theme toggle */
    .theme-toggle {
      display: flex;
      gap: 4px;
    }
    .theme-btn {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.12s;
    }
    .theme-btn.active {
      background: var(--surface3);
      color: var(--text);
      border-color: var(--border2);
    }
    .theme-btn:hover:not(.active) {
      background: var(--surface2);
      color: var(--text);
    }

    /* ── Main area ─────────────────────────────────────────────── */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    /* Top header */
    .topbar {
      height: 56px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 0;
    }
    .topbar-title {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text);
    }
    .topbar-sep {
      width: 1px;
      height: 16px;
      background: var(--border);
      margin: 0 12px;
    }
    .topbar-sub {
      font-size: 0.76rem;
      color: var(--muted);
    }

    /* Tab nav */
    .tab-nav {
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      padding: 0 2rem;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 0.7rem 1rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-size: 0.86rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      letter-spacing: 0.01em;
      transition: color 0.15s, border-color 0.15s;
      margin-bottom: -1px;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    /* Tab panels */
    .tab-panel { display: none; flex: 1; overflow: hidden; flex-direction: column; }
    .tab-panel.active { display: flex; }

    /* ─────────────────────────────────────────────────────────────
       CHAT TAB
    ───────────────────────────────────────────────────────────── */
    #tab-chat {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    #tab-chat.active { display: flex; }

    /* Gate screen */
    .gate {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 3rem 2rem;
      text-align: center;
    }
    .gate-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .gate-sub {
      font-size: 0.88rem;
      color: var(--subtext);
      max-width: 360px;
      line-height: 1.65;
    }
    .gate-eyebrow {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .gate-steps {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 4px;
    }
    .gate-step {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 14px;
      font-size: 0.82rem;
      color: var(--subtext);
      font-weight: 500;
    }
    .gate-step-num {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--accent-soft);
      border: 1px solid rgba(79,114,255,0.25);
      color: var(--accent);
      font-size: 0.68rem;
      font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 0 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .msg-row {
      padding: 0.55rem 2rem;
      border-radius: 0;
      transition: background 0.1s;
    }
    .msg-row:hover { background: rgba(255,255,255,0.018); }

    .msg-meta {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.03em;
      text-transform: uppercase;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .msg-meta-time {
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      color: var(--muted);
      font-size: 0.69rem;
    }
    .meta-you { color: var(--accent); }

    .msg-text {
      font-size: 0.95rem;
      line-height: 1.72;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* User bubble */
    .msg-row-user { align-items: flex-end; }
    .msg-row-user .msg-meta { justify-content: flex-end; }
    .msg-row-user .msg-text {
      background: var(--user-bubble);
      border: 1px solid rgba(79,114,255,0.18);
      border-radius: 10px;
      padding: 0.65rem 0.9rem;
      display: inline-block;
      max-width: 640px;
      margin-left: auto;
    }
    .msg-row-user {
      display: flex;
      flex-direction: column;
    }

    /* Separator */
    .msg-divider {
      height: 1px;
      background: var(--border);
      margin: 0.2rem 2rem;
      opacity: 0.4;
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--muted);
      text-align: center;
      padding: 3rem 2rem;
    }
    .empty-icon {
      width: 44px; height: 44px;
      border: 1.5px solid var(--border2);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 6px;
      opacity: 0.55;
    }
    .empty-icon svg {
      width: 20px; height: 20px;
      stroke: var(--subtext);
      fill: none;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .empty-title {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--subtext);
    }
    .empty-sub {
      font-size: 0.83rem;
      max-width: 320px;
      line-height: 1.6;
    }

    /* Sources */
    .sources-disclosure {
      margin-top: 8px;
      display: inline-block;
    }
    .sources-disclosure summary {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.76rem;
      font-weight: 500;
      color: var(--subtext);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 12px;
      list-style: none;
      user-select: none;
      transition: color 0.12s, background 0.12s, border-color 0.12s;
    }
    .sources-disclosure summary::-webkit-details-marker { display: none; }
    .sources-disclosure summary:hover {
      color: var(--accent);
      background: var(--surface3);
      border-color: rgba(79,114,255,0.3);
    }
    .sources-disclosure[open] summary {
      color: var(--accent);
      background: var(--accent-soft);
      border-color: rgba(79,114,255,0.3);
    }
    .sources-panel {
      margin-top: 8px;
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .source-chip {
      display: inline-flex;
      align-items: center;
      background: var(--surface3);
      border: 1px solid var(--border2);
      border-radius: 5px;
      padding: 3px 10px;
      font-size: 0.76rem;
      color: var(--subtext);
      font-weight: 500;
    }

    /* Input bar */
    .input-bar {
      border-top: 1px solid var(--border);
      padding: 0.85rem 2rem;
      background: var(--surface);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .input-field {
      flex: 1;
      background: var(--bg);
      color: var(--text);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 0 1rem;
      height: 46px;
      font-size: 0.94rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .input-field::placeholder { color: var(--muted); font-size: 0.9rem; }

    .send-btn {
      height: 46px;
      padding: 0 1.4rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.88rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      letter-spacing: 0.01em;
    }
    .send-btn:hover {
      background: var(--accent2);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(79,114,255,0.3);
    }
    .send-btn:active { transform: translateY(0); }
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ─────────────────────────────────────────────────────────────
       UPLOAD TAB
    ───────────────────────────────────────────────────────────── */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 1.5rem;
      max-width: 720px;
    }
    .panel-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 5px;
      letter-spacing: -0.01em;
    }
    .panel-sub {
      font-size: 0.83rem;
      color: var(--muted);
      margin-bottom: 1.4rem;
      line-height: 1.55;
    }

    /* Drop zone */
    .dropzone {
      border: 1.5px dashed var(--border2);
      border-radius: var(--radius-lg);
      background: var(--surface2);
      padding: 2.5rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      position: relative;
    }
    .dropzone:hover,
    .dropzone.drag-over {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .dropzone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }
    .dropzone-icon {
      width: 40px; height: 40px;
      border: 1.5px solid var(--border2);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 12px;
      opacity: 0.6;
    }
    .dropzone-icon svg {
      width: 18px; height: 18px;
      stroke: var(--subtext); fill: none;
      stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;
    }
    .dropzone-label {
      font-size: 0.88rem;
      font-weight: 500;
      color: var(--subtext);
      margin-bottom: 4px;
    }
    .dropzone-label span { color: var(--accent); }
    .dropzone-hint { font-size: 0.76rem; color: var(--muted); }

    #selected-files { margin-top: 1rem; }
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.78rem;
      color: var(--subtext);
      margin: 3px;
    }

    /* Primary button */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.55rem 1.3rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.86rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      letter-spacing: 0.01em;
    }
    .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Ingest results */
    #ingest-results { margin-top: 1.25rem; max-width: 720px; }
    .ingest-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      border-radius: var(--radius);
      padding: 10px 14px;
      margin-bottom: 5px;
      font-size: 0.84rem;
      line-height: 1.5;
    }
    .ingest-ok   { background: var(--success-bg); color: var(--success); border: 1px solid rgba(16,185,129,0.18); }
    .ingest-fail { background: var(--danger-bg);  color: var(--danger);  border: 1px solid rgba(239,68,68,0.18); }
    .ingest-indicator { font-weight: 700; font-size: 1rem; flex-shrink: 0; }
    .ingest-name { font-weight: 600; }
    .ingest-detail { opacity: 0.75; font-size: 0.76rem; margin-top: 1px; }

    /* ─────────────────────────────────────────────────────────────
       DOCUMENTS TAB
    ───────────────────────────────────────────────────────────── */
    .docs-panel { max-width: 720px; }
    .docs-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .docs-title { font-size: 0.95rem; font-weight: 700; color: var(--text); }
    .docs-count {
      background: var(--surface2);
      color: var(--subtext);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 12px;
      font-size: 0.74rem;
      font-weight: 600;
    }
    .doc-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px 16px;
      margin-bottom: 8px;
      transition: border-color 0.12s;
    }
    .doc-card:hover { border-color: var(--border2); }
    .doc-card-badge {
      width: 36px; height: 36px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.62rem; font-weight: 700;
      color: var(--subtext); flex-shrink: 0;
      letter-spacing: 0.04em;
    }
    .doc-card-body { flex: 1; min-width: 0; }
    .doc-card-name {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .doc-card-meta { font-size: 0.73rem; color: var(--muted); margin-top: 2px; }
    .doc-card-remove {
      background: none;
      border: 1px solid rgba(239,68,68,0.25);
      border-radius: 6px;
      color: var(--danger);
      font-size: 0.78rem;
      font-weight: 500;
      padding: 5px 11px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.12s;
    }
    .doc-card-remove:hover { background: var(--danger-bg); }

    .docs-empty {
      text-align: center;
      padding: 3.5rem 1rem;
    }
    .docs-empty-title { font-size: 0.9rem; font-weight: 600; color: var(--subtext); margin-bottom: 8px; }
    .docs-empty-sub { font-size: 0.83rem; color: var(--muted); line-height: 1.6; }

    /* ── Spinner ─────────────────────────────────────────────── */
    .spinner-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13,14,20,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    .spinner-overlay.active { display: flex; }
    .spinner-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2rem 2.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    .spinner-text {
      font-size: 0.86rem;
      color: var(--subtext);
      font-weight: 500;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Toast ─────────────────────────────────────────────────── */
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px 18px;
      font-size: 0.84rem;
      color: var(--text);
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      z-index: 2000;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s, transform 0.2s;
      max-width: 340px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.toast-error { border-left: 3px solid var(--danger); }
    .toast.toast-success { border-left: 3px solid var(--success); }

    /* ── Light theme overrides ─────────────────────────────────── */
    body.light {
      --bg:          #f2f3f8;
      --sidebar:     #ffffff;
      --surface:     #ffffff;
      --surface2:    #edeef6;
      --surface3:    #e4e5f0;
      --border:      #dadbe8;
      --border2:     #c4c6da;
      --text:        #0e0f1a;
      --subtext:     #454668;
      --muted:       #8888a8;
      --accent:      #3556e0;
      --accent2:     #2440ba;
      --accent-glow: rgba(53,86,224,0.15);
      --accent-soft: rgba(53,86,224,0.07);
      --user-bubble: #e6eaff;
      --success:     #059669;
      --danger:      #dc2626;
      --warning:     #d97706;
      --success-bg:  #ecfdf5;
      --danger-bg:   #fef2f2;
      --warning-bg:  #fffbeb;
      --scrollbar:   #c4c6da;
    }
  </style>
</head>
<body>

<!-- Spinner overlay -->
<div class="spinner-overlay" id="spinner">
  <div class="spinner-box">
    <div class="spinner"></div>
    <div class="spinner-text" id="spinner-text">Processing…</div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- App shell -->
<div class="shell">

  <!-- ── Sidebar ───────────────────────────────────────────────── -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
      </div>
      <div>
        <div class="sidebar-brand-name">LogiRAG</div>
        <div class="sidebar-brand-sub">Logistics Intelligence</div>
      </div>
    </div>

    <div class="sidebar-body">
      <span class="section-label">System Status</span>
      <div class="status-group" id="status-area">
        <div class="status-pill status-warn">
          <span class="status-dot dot-warn"></span>Checking…
        </div>
      </div>

      <hr class="sidebar-divider" />

      <span class="section-label">Documents</span>
      <ul id="doc-list">
        <li><span class="no-docs-note">Loading…</span></li>
      </ul>

      <div id="clear-chat-wrap" style="display:none; margin-top:0.5rem;">
        <hr class="sidebar-divider" />
        <button class="sidebar-btn" id="clear-chat-btn">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
          Clear conversation
        </button>
      </div>
    </div>

    <div class="sidebar-footer">
      <span class="section-label" style="margin-bottom:0.4rem;">Appearance</span>
      <div class="theme-toggle">
        <button class="theme-btn active" id="theme-dark" onclick="setTheme('dark')">Dark</button>
        <button class="theme-btn" id="theme-light" onclick="setTheme('light')">Light</button>
      </div>
    </div>
  </aside>

  <!-- ── Main ─────────────────────────────────────────────────── -->
  <div class="main">

    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <span class="topbar-title">LogiRAG</span>
        <div class="topbar-sep"></div>
        <span class="topbar-sub">Logistics Document Intelligence</span>
      </div>
      <div id="topbar-status"></div>
    </div>

    <!-- Tab nav -->
    <nav class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('chat')">Chat</button>
      <button class="tab-btn" onclick="switchTab('upload')">Upload Documents</button>
      <button class="tab-btn" onclick="switchTab('docs')">Manage Documents</button>
    </nav>

    <!-- ── Chat tab ──────────────────────────────────────────── -->
    <div class="tab-panel active" id="tab-chat">

      <!-- Gate: no docs -->
      <div class="gate" id="gate" style="display:none;">
        <div class="gate-eyebrow">Getting Started</div>
        <div class="gate-title">No Documents Loaded</div>
        <div class="gate-sub">
          Upload logistics PDF files to begin asking questions.
          Non-logistics documents are automatically rejected.
        </div>
        <div class="gate-steps">
          <div class="gate-step">
            <div class="gate-step-num">1</div>
            Open <strong>Upload Documents</strong>
          </div>
          <div class="gate-step">
            <div class="gate-step-num">2</div>
            Select and ingest PDF files
          </div>
          <div class="gate-step">
            <div class="gate-step-num">3</div>
            Return here and chat
          </div>
        </div>
      </div>

      <!-- Chat view: ready -->
      <div id="chat-view" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
        <!-- Messages -->
        <div class="messages" id="messages">
          <div class="empty-state" id="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div class="empty-title">Start a conversation</div>
            <div class="empty-sub">Ask anything about your logistics documents — shipments, routes, carriers, timelines, compliance, and more.</div>
          </div>
        </div>

        <!-- Input bar -->
        <div class="input-bar">
          <input
            type="text"
            id="chat-input"
            class="input-field"
            placeholder="Ask a question about your logistics documents…"
            autocomplete="off"
          />
          <button class="send-btn" id="send-btn">Send</button>
        </div>
      </div>
    </div>

    <!-- ── Upload tab ─────────────────────────────────────────── -->
    <div class="tab-panel" id="tab-upload">
      <div class="tab-content">
        <div class="panel">
          <div class="panel-title">Upload Logistics Documents</div>
          <div class="panel-sub">
            Upload one or more PDF files. Only logistics and transport-related documents are accepted;
            others will be automatically rejected by the AI classifier.
          </div>

          <div class="dropzone" id="dropzone">
            <input type="file" id="file-input" accept=".pdf" multiple />
            <div class="dropzone-icon">
              <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <div class="dropzone-label">Drop PDF files here, or <span>click to browse</span></div>
            <div class="dropzone-hint">Supports PDF files only</div>
          </div>

          <div id="selected-files"></div>

          <div style="margin-top:1.25rem;">
            <button class="btn-primary" id="ingest-btn" disabled>
              Process and Ingest
            </button>
          </div>
        </div>

        <div id="ingest-results"></div>
      </div>
    </div>

    <!-- ── Documents tab ──────────────────────────────────────── -->
    <div class="tab-panel" id="tab-docs">
      <div class="tab-content">
        <div class="docs-panel">
          <div class="docs-header">
            <div class="docs-title">Indexed Documents</div>
            <span class="docs-count" id="docs-count">0 documents</span>
          </div>
          <div id="docs-list-main"></div>
        </div>
      </div>
    </div>

  </div><!-- /.main -->
</div><!-- /.shell -->

<script>
'use strict';

// ── Config ──────────────────────────────────────────────────────────────────
const API = '';   // same origin — served by FastAPI at /
let docsReady = false;
let chatHistory = [];
let currentDocs = [];

// ── Helpers ─────────────────────────────────────────────────────────────────
function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmtTime(d) {
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function showSpinner(msg = 'Processing…') {
  $('#spinner-text').textContent = msg;
  $('#spinner').classList.add('active');
}
function hideSpinner() { $('#spinner').classList.remove('active'); }

function showToast(msg, type = '') {
  const t = $('#toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' toast-' + type : '');
  setTimeout(() => {
    t.classList.remove('show');
  }, 3500);
}

// ── Theme ────────────────────────────────────────────────────────────────────
function setTheme(mode) {
  document.body.classList.toggle('light', mode === 'light');
  $('#theme-dark').classList.toggle('active', mode === 'dark');
  $('#theme-light').classList.toggle('active', mode === 'light');
  localStorage.setItem('logirag-theme', mode);
}
(function initTheme() {
  const saved = localStorage.getItem('logirag-theme') || 'dark';
  setTheme(saved);
})();

// ── Tabs ─────────────────────────────────────────────────────────────────────
function switchTab(name) {
  $$('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['chat','upload','docs'][i] === name);
  });
  $$('.tab-panel').forEach(p => p.classList.remove('active'));
  $('#tab-' + name).classList.add('active');
}

// ── API calls ────────────────────────────────────────────────────────────────
async function fetchHealth() {
  try {
    const r = await fetch(`${API}/health`);
    return r.ok ? r.json() : null;
  } catch { return null; }
}

async function fetchDocuments() {
  try {
    const r = await fetch(`${API}/documents`);
    return r.ok ? (await r.json()).documents || [] : [];
  } catch { return []; }
}

async function deleteDoc(filename) {
  const r = await fetch(`${API}/documents/${encodeURIComponent(filename)}`, { method: 'DELETE' });
  return r.ok;
}

async function sendChat(question) {
  const r = await fetch(`${API}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question, include_sources: true })
  });
  if (!r.ok) {
    const err = await r.json().catch(() => ({ detail: 'Server error' }));
    throw new Error(err.detail || 'Error');
  }
  return r.json();
}

async function uploadFiles(files) {
  const fd = new FormData();
  for (const f of files) fd.append('files', f);
  const r = await fetch(`${API}/upload`, { method: 'POST', body: fd });
  return { status: r.status, data: await r.json().catch(() => ({})) };
}

// ── Status & sidebar ─────────────────────────────────────────────────────────
function renderStatus(health, docs) {
  const area = $('#status-area');
  const topbar = $('#topbar-status');
  if (!health) {
    area.innerHTML = `
      <div class="status-pill status-offline"><span class="status-dot dot-offline"></span>Backend offline</div>
      <div class="offline-notice">Start the backend server:<br/><code>uvicorn app:app --reload</code></div>`;
    topbar.innerHTML = `<div class="status-pill status-offline"><span class="status-dot dot-offline"></span>Backend offline</div>`;
    return;
  }
  const vsReady = health.vectorstore_initialized;
  area.innerHTML = `
    <div class="status-pill status-online"><span class="status-dot dot-online"></span>Backend connected</div>
    <div class="status-pill ${vsReady ? 'status-online' : 'status-warn'}" style="margin-top:4px;">
      <span class="status-dot ${vsReady ? 'dot-online' : 'dot-warn'}"></span>
      ${vsReady ? `${docs.length} document${docs.length !== 1 ? 's' : ''} ready` : 'No documents loaded'}
    </div>`;
  topbar.innerHTML = vsReady
    ? `<div class="status-pill status-online"><span class="status-dot dot-online"></span>Ready &mdash; ${docs.length} document${docs.length !== 1 ? 's' : ''}</div>`
    : `<div class="status-pill status-warn"><span class="status-dot dot-warn"></span>No documents loaded</div>`;
}

function renderSidebarDocs(docs) {
  const list = $('#doc-list');
  if (!docs.length) {
    list.innerHTML = '<li><span class="no-docs-note">No documents loaded.</span></li>';
    return;
  }
  list.innerHTML = docs.map(d => `
    <li class="doc-item">
      <div class="doc-badge">PDF</div>
      <span class="doc-name" title="${esc(d.filename)}">${esc(d.filename)}</span>
      <span class="doc-size">${d.size_kb}k</span>
      <button class="doc-remove" onclick="handleDelete('${esc(d.filename)}')" title="Remove">x</button>
    </li>`).join('');
}

function renderChatGate(docs) {
  docsReady = docs.length > 0;
  $('#gate').style.display = docsReady ? 'none' : 'flex';
  $('#chat-view').style.display = docsReady ? 'flex' : 'none';
  // Clear chat button visibility
  $('#clear-chat-wrap').style.display = chatHistory.length > 0 ? 'block' : 'none';
}

async function refreshAll() {
  const [health, docs] = await Promise.all([fetchHealth(), fetchDocuments()]);
  currentDocs = docs;
  renderStatus(health, docs);
  renderSidebarDocs(docs);
  renderChatGate(docs);
  renderDocsTab(docs);
}

// ── Documents tab ────────────────────────────────────────────────────────────
function renderDocsTab(docs) {
  const count = $('#docs-count');
  const list  = $('#docs-list-main');
  count.textContent = `${docs.length} document${docs.length !== 1 ? 's' : ''}`;

  if (!docs.length) {
    list.innerHTML = `
      <div class="docs-empty">
        <div class="docs-empty-title">No documents indexed</div>
        <div class="docs-empty-sub">Upload PDF files in the <strong>Upload Documents</strong> tab to get started.</div>
      </div>`;
    return;
  }

  list.innerHTML = docs.map(d => `
    <div class="doc-card">
      <div class="doc-card-badge">PDF</div>
      <div class="doc-card-body">
        <div class="doc-card-name" title="${esc(d.filename)}">${esc(d.filename)}</div>
        <div class="doc-card-meta">${d.size_kb} KB &middot; PDF</div>
      </div>
      <button class="doc-card-remove" onclick="handleDelete('${esc(d.filename)}')">Remove</button>
    </div>`).join('');
}

async function handleDelete(filename) {
  showSpinner('Removing document…');
  try {
    const ok = await deleteDoc(filename);
    if (ok) {
      showToast(`"${filename}" removed.`, 'success');
      chatHistory = [];
      renderMessages();
      await refreshAll();
    } else {
      showToast('Failed to remove document.', 'error');
    }
  } catch {
    showToast('Connection error.', 'error');
  }
  hideSpinner();
}

// ── Chat ─────────────────────────────────────────────────────────────────────
function renderMessages() {
  const container = $('#messages');
  if (!chatHistory.length) {
    container.innerHTML = `
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        <div class="empty-title">Start a conversation</div>
        <div class="empty-sub">Ask anything about your logistics documents — shipments, routes, carriers, timelines, compliance, and more.</div>
      </div>`;
    $('#clear-chat-wrap').style.display = 'none';
    return;
  }

  $('#clear-chat-wrap').style.display = 'block';

  let html = '';
  chatHistory.forEach((msg, i) => {
    const time = esc(msg.time);
    const content = esc(msg.content);

    if (msg.role === 'user') {
      html += `
        <div class="msg-row msg-row-user">
          <div class="msg-meta"><span class="meta-you">You</span><span class="msg-meta-time">${time}</span></div>
          <div class="msg-text">${content}</div>
        </div>`;
    } else {
      // Build sources pill
      let sourcesHtml = '';
      if (msg.sources && msg.sources.length) {
        const count = msg.sources.length;
        const chips = msg.sources.map(s =>
          `<span class="source-chip">${esc(s.filename)} &middot; p.${esc(String(s.page))}</span>`
        ).join('');
        sourcesHtml = `
          <details class="sources-disclosure">
            <summary>${count} source${count !== 1 ? 's' : ''}</summary>
            <div class="sources-panel">${chips}</div>
          </details>`;
      }
      html += `
        <div class="msg-row">
          <div class="msg-meta">LogiRAG<span class="msg-meta-time">${time}</span></div>
          <div class="msg-text">${content}</div>
          ${sourcesHtml}
        </div>`;
    }

    // Divider between turns (not last)
    if (i < chatHistory.length - 1) {
      html += '<div class="msg-divider"></div>';
    }
  });

  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

async function handleSend() {
  const input  = $('#chat-input');
  const sendBtn = $('#send-btn');
  const question = input.value.trim();
  if (!question) return;

  input.value = '';
  sendBtn.disabled = true;

  chatHistory.push({ role: 'user', content: question, time: fmtTime(new Date()) });
  renderMessages();

  try {
    const result = await sendChat(question);
    chatHistory.push({
      role: 'assistant',
      content: result.answer || 'No answer returned.',
      sources: result.sources || [],
      time: fmtTime(new Date())
    });
  } catch(e) {
    chatHistory.push({
      role: 'assistant',
      content: `Error: ${e.message}`,
      sources: [],
      time: fmtTime(new Date())
    });
  }

  renderMessages();
  sendBtn.disabled = false;
  input.focus();
}

// ── Upload ────────────────────────────────────────────────────────────────────
let selectedFiles = [];

function updateFileChips() {
  const el = $('#selected-files');
  const btn = $('#ingest-btn');
  if (!selectedFiles.length) { el.innerHTML = ''; btn.disabled = true; return; }
  el.innerHTML = selectedFiles.map(f =>
    `<span class="file-chip">PDF &nbsp; ${esc(f.name)}</span>`
  ).join('');
  btn.disabled = false;
}

$('#file-input').addEventListener('change', function() {
  selectedFiles = Array.from(this.files);
  updateFileChips();
});

// Drag-and-drop
const dz = $('#dropzone');
['dragenter','dragover'].forEach(ev => {
  dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag-over'); });
});
['dragleave','drop'].forEach(ev => {
  dz.addEventListener(ev, e => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    if (ev === 'drop' && e.dataTransfer.files.length) {
      selectedFiles = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.pdf'));
      updateFileChips();
    }
  });
});

$('#ingest-btn').addEventListener('click', async function() {
  if (!selectedFiles.length) return;
  showSpinner('Classifying and embedding documents…');
  const resultsEl = $('#ingest-results');
  resultsEl.innerHTML = '';

  try {
    const { status, data } = await uploadFiles(selectedFiles);
    selectedFiles = [];
    updateFileChips();
    $('#file-input').value = '';

    let html = '<span class="section-label" style="margin-bottom:0.5rem;display:block;">Ingest Results</span>';

    if (status === 200) {
      (data.files_processed || []).forEach(f => {
        html += `<div class="ingest-row ingest-ok">
          <span class="ingest-indicator">+</span>
          <div><div class="ingest-name">${esc(f.filename)}</div><div class="ingest-detail">${f.chunks} chunks indexed</div></div></div>`;
      });
      (data.files_rejected || []).forEach(f => {
        html += `<div class="ingest-row ingest-fail">
          <span class="ingest-indicator">-</span>
          <div><div class="ingest-name">${esc(f.filename)}</div><div class="ingest-detail">${esc(f.reason)}</div></div></div>`;
      });
      showToast('Ingest complete.', 'success');
    } else if (status === 422) {
      const detail = data.detail || {};
      (detail.rejected || []).forEach(f => {
        html += `<div class="ingest-row ingest-fail">
          <span class="ingest-indicator">-</span>
          <div><div class="ingest-name">${esc(f.filename)}</div><div class="ingest-detail">${esc(f.reason)}</div></div></div>`;
      });
      showToast('All files were rejected.', 'error');
    } else {
      html += `<div class="ingest-row ingest-fail"><span class="ingest-indicator">-</span><div>Upload failed (HTTP ${status})</div></div>`;
      showToast('Upload failed.', 'error');
    }

    resultsEl.innerHTML = html;
    await refreshAll();
  } catch(e) {
    showToast('Connection error: ' + e.message, 'error');
  }
  hideSpinner();
});

// ── Clear chat ────────────────────────────────────────────────────────────────
$('#clear-chat-btn').addEventListener('click', () => {
  chatHistory = [];
  renderMessages();
  $('#clear-chat-wrap').style.display = 'none';
});

// ── Send on Enter ─────────────────────────────────────────────────────────────
$('#chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
});
$('#send-btn').addEventListener('click', handleSend);

// ── Poll / init ───────────────────────────────────────────────────────────────
(async function init() {
  await refreshAll();
  // Refresh status every 10s
  setInterval(refreshAll, 10000);
})();
</script>
</body>
</html>